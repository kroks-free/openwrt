include $(TOPDIR)/rules.mk
include $(INCLUDE_DIR)/kernel.mk

PKG_NAME:=mtk-eip93
PKG_RELEASE:=2
PKG_LICENSE:=GPLv2

PKG_BUILD_PARALLEL:=1

PKG_CONFIG_DEPENDS += \
	CONFIG_PACKAGE_MTK_EIP93_SKCIPHER \
	CONFIG_PACKAGE_MTK_EIP93_HMAC \
	CONFIG_PACKAGE_MTK_EIP93_AES \
	CONFIG_PACKAGE_MTK_EIP93_DES \
	CONFIG_PACKAGE_MTK_EIP93_AEAD  \
	CONFIG_PACKAGE_MTK_EIP93_GENERIC_SW_MAX_LEN \
	CONFIG_PACKAGE_MTK_EIP93_AES_128_SW_MAX_LEN

include $(INCLUDE_DIR)/package.mk

define KernelPackage/crypto-hw-eip93/config
  source "$(SOURCE)/Config.in"
endef

define KernelPackage/crypto-hw-eip93
  SECTION:=kernel
  SUBMENU:=Cryptographic API modules
  TITLE:=MTK EIP93 crypto module
  DEPENDS:=@TARGET_ramips_mt7621 \
	+PACKAGE_MTK_EIP93_DES:kmod-crypto-des \
	+PACKAGE_MTK_EIP93_AEAD:kmod-crypto-authenc \
	+PACKAGE_MTK_EIP93_AEAD:kmod-crypto-md5 \
	+PACKAGE_MTK_EIP93_AEAD:kmod-crypto-sha1 \
	+PACKAGE_MTK_EIP93_AEAD:kmod-crypto-sha256
  KCONFIG:=CONFIG_CRYPTO_HW=y
  FILES:=$(PKG_BUILD_DIR)/crypto-hw-eip93.ko
  AUTOLOAD:=$(call AutoLoad,09,crypto-hw-eip93)
endef

define KernelPackage/crypto-hw-eip93/description
Kernel module to enable EIP-93 Crypto engine as found
in the Mediatek MT7621 SoC.
It enables DES/3DES/AES ECB/CBC/CTR and
IPSEC offload with authenc(hmac(sha1/sha256), aes/cbc/rfc3686)
endef

ifdef CONFIG_PACKAGE_MTK_EIP93_SKCIPHER
  PKG_MAKE_CFLAGS += -DCONFIG_CRYPTO_DEV_EIP93_SKCIPHER
  PKG_MAKE_KCONFIG += CONFIG_CRYPTO_DEV_EIP93_SKCIPHER=y
  ifdef CONFIG_PACKAGE_MTK_EIP93_AES
    PKG_MAKE_CFLAGS += -DCONFIG_CRYPTO_DEV_EIP93_AES
  endif
  ifdef CONFIG_PACKAGE_MTK_EIP93_DES
    PKG_MAKE_CFLAGS += -DCONFIG_CRYPTO_DEV_EIP93_DES
  endif
endif

ifdef CONFIG_PACKAGE_MTK_EIP93_HMAC
  PKG_MAKE_CFLAGS += -DCONFIG_CRYPTO_DEV_EIP93_HMAC -DCONFIG_CRYPTO_DEV_EIP93_AEAD
  PKG_MAKE_KCONFIG += CONFIG_CRYPTO_DEV_EIP93_AEAD=y
endif

ifdef CONFIG_PACKAGE_MTK_EIP93_GENERIC_SW_MAX_LEN
  PKG_MAKE_CFLAGS += -DCONFIG_CRYPTO_DEV_EIP93_GENERIC_SW_MAX_LEN=$(CONFIG_PACKAGE_MTK_EIP93_GENERIC_SW_MAX_LEN)
endif

ifdef CONFIG_PACKAGE_MTK_EIP93_AES_128_SW_MAX_LEN
  PKG_MAKE_CFLAGS += -DCONFIG_CRYPTO_DEV_EIP93_AES_128_SW_MAX_LEN=$(CONFIG_PACKAGE_MTK_EIP93_AES_128_SW_MAX_LEN)
endif

define Build/Compile
	+$(KERNEL_MAKE) $(PKG_JOBS) \
		EXTRA_CFLAGS="$(PKG_MAKE_CFLAGS)" \
		$(PKG_MAKE_KCONFIG) \
		M="$(PKG_BUILD_DIR)" \
		modules
endef

$(eval $(call KernelPackage,crypto-hw-eip93))
